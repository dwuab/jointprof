<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to joint profiling of native and R code • jointprof</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to joint profiling of native and R code">
<meta property="og:description" content="jointprof">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">jointprof</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.1.9001</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/jointprof.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/internals.html">Collecting and merging dual call stacks</a>
    </li>
    <li>
      <a href="../articles/proposal.html">Proposal: Joint profiling of native and R code</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/r-prof/jointprof/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="jointprof_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Introduction to joint profiling of native and R code</h1>
                        <h4 data-toc-skip class="author">Kirill Müller</h4>
            
            <h4 data-toc-skip class="date">2021-03-27</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/r-prof/jointprof/blob/master/vignettes/jointprof.Rmd" class="external-link"><code>vignettes/jointprof.Rmd</code></a></small>
      <div class="hidden name"><code>jointprof.Rmd</code></div>

    </div>

    
    
<p>The three rules of software optimization are:</p>
<ol style="list-style-type: decimal">
<li>Don’t.</li>
<li>Don’t do it yet.</li>
<li>Profile before optimizing.</li>
</ol>
<p>A profiler is a tool that identifies which parts of your code take the most time. One way to do this is to run the code and halt execution every so often (by default 50 times per second), and record the <a href="https://www.rdocumentation.org/packages/base/versions/3.4.3/topics/sys.parent" class="external-link">call stack</a> on each occurrence. The combined samples will likely show in which part of your code the most time is spent.</p>
<p>In R, a sampling profiler is available via <a href="https://www.rdocumentation.org/packages/utils/versions/3.4.3/topics/Rprof" class="external-link"><code>Rprof()</code></a>, but it provides detailed measurements only for R code. This vignette shows how to include detailed information on native code run times in the profile.</p>
<div id="prerequisite-code-to-profile" class="section level2">
<h2 class="hasAnchor">
<a href="#prerequisite-code-to-profile" class="anchor"></a>Prerequisite: Code to profile</h2>
<p>For this vignette, we’ll be profiling R and C++ implementations of functions that computes the Fibonacci sequence using <a href="https://en.wikipedia.org/wiki/Dynamic_programming#In_computer_programming" class="external-link">dynamic programming</a>:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fib_r</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span> <span class="op">(</span><span class="va">x</span> <span class="op">&lt;=</span> <span class="fl">2</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">x</span><span class="op">)</span><span class="op">)</span>
  <span class="va">fib</span> <span class="op">&lt;-</span> <span class="fu">fib_r</span><span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">fib</span>, <span class="va">fib</span><span class="op">[</span><span class="va">x</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">fib</span><span class="op">[</span><span class="va">x</span> <span class="op">-</span> <span class="fl">2</span><span class="op">]</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2"></a></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb2-4"><a href="#cb2-4"></a>Rcpp::NumericVector fib_cpp(<span class="dt">int</span> x) {</span>
<span id="cb2-5"><a href="#cb2-5"></a>  <span class="cf">if</span> (x &lt;= <span class="dv">1</span>) <span class="cf">return</span> Rcpp::NumericVector::create(<span class="dv">1</span>);</span>
<span id="cb2-6"><a href="#cb2-6"></a>  <span class="cf">if</span> (x &lt;= <span class="dv">2</span>) <span class="cf">return</span> Rcpp::NumericVector::create(<span class="dv">1</span>, <span class="dv">1</span>);</span>
<span id="cb2-7"><a href="#cb2-7"></a>  Rcpp::NumericVector fib = fib_cpp(x - <span class="dv">1</span>);</span>
<span id="cb2-8"><a href="#cb2-8"></a></span>
<span id="cb2-9"><a href="#cb2-9"></a>  <span class="co">// Zero-based indexing!</span></span>
<span id="cb2-10"><a href="#cb2-10"></a>  fib.push_back(fib[x - <span class="dv">1</span> - <span class="dv">1</span>] + fib[x - <span class="dv">2</span> - <span class="dv">1</span>]);</span>
<span id="cb2-11"><a href="#cb2-11"></a></span>
<span id="cb2-12"><a href="#cb2-12"></a>  <span class="cf">return</span> fib;</span>
<span id="cb2-13"><a href="#cb2-13"></a>}</span></code></pre></div>
<p>(A few tweaks are necessary to allow profiling the <em>Rcpp</em>-compiled function when run from the vignette. See the source for details.)</p>
<p>The implementations are supposed to behave identically.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">fib_r</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>
<span class="co">#&gt;  [1]  1  1  2  3  5  8 13 21 34 55</span>
<span class="fu">fib_cpp</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>
<span class="co">#&gt;  [1]  1  1  2  3  5  8 13 21 34 55</span></code></pre></div>
<p>Our test function <code>test()</code> calls both functions and compares their output in a loop:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">test</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="fu">fib_r</span><span class="op">(</span><span class="va">i</span><span class="op">)</span>, <span class="fu">fib_cpp</span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="a-minimal-example" class="section level2">
<h2 class="hasAnchor">
<a href="#a-minimal-example" class="anchor"></a>A minimal example</h2>
<p><code><a href="https://rdrr.io/r/utils/Rprof.html" class="external-link">Rprof()</a></code> creates a text file that contains the stack trace for each interruption. The <a href="https://www.rdocumentation.org/packages/utils/versions/3.4.3/topics/summaryRprof" class="external-link"><code>summaryRprof()</code></a> function converts this to a data frame with one row per function and the corresponding run time estimates (self: code in that function only, total: including all descendant functions):</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">out_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="st">"jointprof"</span>, fileext <span class="op">=</span> <span class="st">".out"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/Rprof.html" class="external-link">Rprof</a></span><span class="op">(</span><span class="va">out_file</span>, gc.profiling <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span> <span class="fu">test</span><span class="op">(</span><span class="fl">800</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/Rprof.html" class="external-link">Rprof</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span>

<span class="va">summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/summaryRprof.html" class="external-link">summaryRprof</a></span><span class="op">(</span><span class="va">out_file</span><span class="op">)</span>
<span class="va">summary</span><span class="op">$</span><span class="va">by.self</span>
<span class="co">#&gt;             self.time self.pct total.time total.pct</span>
<span class="co">#&gt; "fib_r"          4.86    34.66      10.74     76.60</span>
<span class="co">#&gt; "c"              4.74    33.81       5.30     37.80</span>
<span class="co">#&gt; ".Call"          2.76    19.69       3.22     22.97</span>
<span class="co">#&gt; "&lt;GC&gt;"           1.22     8.70       1.22      8.70</span>
<span class="co">#&gt; "-"              0.24     1.71       0.26      1.85</span>
<span class="co">#&gt; "&lt;="             0.08     0.57       0.08      0.57</span>
<span class="co">#&gt; "+"              0.06     0.43       0.06      0.43</span>
<span class="co">#&gt; "test"           0.02     0.14      14.02    100.00</span>
<span class="co">#&gt; "stopifnot"      0.02     0.14      14.00     99.86</span>
<span class="co">#&gt; "...elt"         0.02     0.14      13.98     99.71</span></code></pre></div>
<p>This is a nice overview, but for <code>fun_cpp()</code> the run time is hidden in the entry for <a href="https://www.rdocumentation.org/packages/base/versions/3.4.3/topics/CallExternal" class="external-link"><code>.Call()</code></a>: calls into native code are opaque and cannot be resolved further. Enter joint profiling:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-prof.github.io/jointprof/" class="external-link">jointprof</a></span><span class="op">)</span>
<span class="va">out_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="st">"jointprof"</span>, fileext <span class="op">=</span> <span class="st">".out"</span><span class="op">)</span>
<span class="fu"><a href="../reference/start_profiler.html">start_profiler</a></span><span class="op">(</span><span class="va">out_file</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span> <span class="fu">test</span><span class="op">(</span><span class="fl">700</span><span class="op">)</span>
<span class="fu"><a href="../reference/start_profiler.html">stop_profiler</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/summaryRprof.html" class="external-link">summaryRprof</a></span><span class="op">(</span><span class="va">out_file</span><span class="op">)</span>
<span class="va">summary</span><span class="op">$</span><span class="va">by.self</span></code></pre></div>
<p>The summary now also contains a breakdown for native functions below the R code that calls them.</p>
</div>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h2>
<div id="ubuntu" class="section level3">
<h3 class="hasAnchor">
<a href="#ubuntu" class="anchor"></a>Ubuntu</h3>
<p>Other Linux distributions may work if you install the right system dependencies (<a href="https://github.com/r-prof/jointprof/issues" class="external-link">let me know</a> which!).</p>
<ol style="list-style-type: decimal">
<li>
<p>Install system dependencies:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1"></a><span class="fu">sudo</span> apt install \</span>
<span id="cb7-2"><a href="#cb7-2"></a>  libgoogle-perftools-dev \</span>
<span id="cb7-3"><a href="#cb7-3"></a>  libprotoc-dev libprotobuf-dev protobuf-compiler \</span>
<span id="cb7-4"><a href="#cb7-4"></a>  golang-go \</span>
<span id="cb7-5"><a href="#cb7-5"></a>  graphviz</span></code></pre></div>
</li>
<li>
<p>Install <code>pprof</code>:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1"></a><span class="ex">go</span> get github.com/google/pprof</span></code></pre></div>
</li>
<li>
<p>Install the package:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># install.packages("remotes")</span>
<span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"r-prof/jointprof"</span><span class="op">)</span></code></pre></div>
</li>
</ol>
</div>
<div id="os-x" class="section level3">
<h3 class="hasAnchor">
<a href="#os-x" class="anchor"></a>OS X</h3>
<ol style="list-style-type: decimal">
<li>
<p>Install system dependencies:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1"></a><span class="ex">brew</span> install graphviz</span></code></pre></div>
</li>
<li>
<p>Install <code>gperftools</code> (currently from a branch, <a href="https://github.com/gperftools/gperftools/pull/1004" class="external-link">pull request</a> pending):</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1"></a><span class="fu">git</span> clone https://github.com/krlmlr/gperftools.git -b f-export-stack</span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="bu">cd</span> gperftools</span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="ex">./autogen.sh</span></span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="ex">./configure</span></span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="fu">make</span></span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="fu">sudo</span> make install</span>
<span id="cb11-7"><a href="#cb11-7"></a><span class="bu">cd</span> ..</span></code></pre></div>
</li>
<li>
<p>Install <code>pprof</code>:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1"></a><span class="ex">go</span> get github.com/google/pprof</span></code></pre></div>
</li>
<li>
<p>Install the package:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># install.packages("remotes")</span>
<span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"r-prof/jointprof"</span><span class="op">)</span></code></pre></div>
</li>
</ol>
</div>
<div id="other-os" class="section level3">
<h3 class="hasAnchor">
<a href="#other-os" class="anchor"></a>Other OS</h3>
<p>Windows and Solaris are not supported.</p>
</div>
</div>
<div id="usage" class="section level2">
<h2 class="hasAnchor">
<a href="#usage" class="anchor"></a>Usage</h2>
<p>The <a href="https://r-prof.github.io/jointprof/reference/start_profiler.html" class="external-link"><code>start_profiler()</code> and <code>stop_profiler()</code></a> functions are replacements for <code><a href="https://rdrr.io/r/utils/Rprof.html" class="external-link">Rprof()</a></code> and <code><a href="https://rdrr.io/r/utils/Rprof.html" class="external-link">Rprof(NULL)</a></code>, respectively. The generated output file is compatible with that generated by <code><a href="https://rdrr.io/r/utils/Rprof.html" class="external-link">Rprof()</a></code>. This enables a variety of ways to analyze the results, see also the subsequent section.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">out_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="st">"jointprof"</span>, fileext <span class="op">=</span> <span class="st">".out"</span><span class="op">)</span>
<span class="fu"><a href="../reference/start_profiler.html">start_profiler</a></span><span class="op">(</span><span class="va">out_file</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span> <span class="fu">test</span><span class="op">(</span><span class="fl">700</span><span class="op">)</span>
<span class="fu"><a href="../reference/start_profiler.html">stop_profiler</a></span><span class="op">(</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/strtrim.html" class="external-link">strtrim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="va">out_file</span>, n <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>, <span class="fl">90</span><span class="op">)</span></code></pre></div>
<p>Furthermore <code><a href="../reference/start_profiler.html">stop_profiler()</a></code> returns an in-memory representation of the profiled data, invisibly. See <a href="https://r-prof.github.io/profile/reference/validate_profile.html" class="external-link"><code>?profiler::validate_profile</code></a> for a description of the data format.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">out_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="st">"jointprof"</span>, fileext <span class="op">=</span> <span class="st">".out"</span><span class="op">)</span>
<span class="fu"><a href="../reference/start_profiler.html">start_profiler</a></span><span class="op">(</span><span class="va">out_file</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span> <span class="fu">test</span><span class="op">(</span><span class="fl">700</span><span class="op">)</span>
<span class="va">profile_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/start_profiler.html">stop_profiler</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">profile_data</span>

<span class="va">profile_data</span><span class="op">$</span><span class="va">samples</span>
<span class="va">profile_data</span><span class="op">$</span><span class="va">locations</span>
<span class="va">profile_data</span><span class="op">$</span><span class="va">functions</span></code></pre></div>
<p>The profile data can be edited, and written to a file via <a href="https://r-prof.github.io/profile/reference/write_rprof.html" class="external-link"><code>write_rprof()</code></a> or (in <a href="https://github.com/google/pprof" class="external-link"><code>pprof</code></a>-compatible format) via <a href="https://r-prof.github.io/profile/reference/write_pprof.html" class="external-link"><code>profile::write_pprof()</code></a>. The example below removes the first 15 entries from all samples, and writes the resulting profile data in <code>pprof</code> format:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">profile_data</span><span class="op">$</span><span class="va">samples</span><span class="op">$</span><span class="va">locations</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span>
  <span class="va">profile_data</span><span class="op">$</span><span class="va">samples</span><span class="op">$</span><span class="va">locations</span>,
  <span class="va">head</span>,
  <span class="op">-</span><span class="fl">15</span>
<span class="op">)</span>

<span class="va">pprof_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="st">"jointprof"</span>, fileext <span class="op">=</span> <span class="st">".pb.gz"</span><span class="op">)</span>
<span class="fu">profile</span><span class="fu">::</span><span class="fu"><a href="https://r-prof.github.io/profile/reference/read_rprof.html" class="external-link">write_pprof</a></span><span class="op">(</span><span class="va">profile_data</span>, <span class="va">pprof_file</span><span class="op">)</span></code></pre></div>
<p>We then use <code>pprof</code> to visualize the call <em>graph</em>, using <a href="https://r-prof.github.io/jointprof/reference/find_pprof.html" class="external-link"><code>find_pprof()</code></a> to get the path to the <code>pprof</code> executable:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="fu">knit_dir</span><span class="op">(</span><span class="st">"jointprof_fig"</span><span class="op">)</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">svg_file</span> <span class="op">&lt;-</span> <span class="fu">knit_dir</span><span class="op">(</span><span class="st">"jointprof_fig/minimal.svg"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/system2.html" class="external-link">system2</a></span><span class="op">(</span>
  <span class="fu"><a href="../reference/find_pprof.html">find_pprof</a></span><span class="op">(</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>
    <span class="st">"-svg"</span>,
    <span class="st">"-nodefraction 0.01"</span>,
    <span class="st">"-output"</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/shQuote.html" class="external-link">shQuote</a></span><span class="op">(</span><span class="va">svg_file</span><span class="op">)</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/shQuote.html" class="external-link">shQuote</a></span><span class="op">(</span><span class="va">pprof_file</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span>

<span class="va">png_file</span> <span class="op">&lt;-</span> <span class="fu">knit_dir</span><span class="op">(</span><span class="st">"jointprof_fig/minimal.png"</span><span class="op">)</span>
<span class="fu">rsvg</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rsvg/man/rsvg.html" class="external-link">rsvg_png</a></span><span class="op">(</span><span class="va">svg_file</span>, <span class="va">png_file</span>, width <span class="op">=</span> <span class="fl">680</span><span class="op">)</span></code></pre></div>
<p><a href="jointprof_fig/minimal.svg"><img src="jointprof_fig/minimal.png" alt="Call graph (click to show image)"></a></p>
<p>The call graph shows a unified view of run time costs for both R and native code. (Click on the image to see the SVG version.)</p>
<p>For interactive exploration of a call graph, try the built-in web browser view:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/system2.html" class="external-link">system2</a></span><span class="op">(</span>
  <span class="fu"><a href="../reference/find_pprof.html">find_pprof</a></span><span class="op">(</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>
    <span class="st">"-http"</span>,
    <span class="st">"localhost:8080"</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/shQuote.html" class="external-link">shQuote</a></span><span class="op">(</span><span class="va">pprof_file</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span></code></pre></div>
</div>
<div id="other-packages-for-analyzing-profiler-data" class="section level2">
<h2 class="hasAnchor">
<a href="#other-packages-for-analyzing-profiler-data" class="anchor"></a>Other packages for analyzing profiler data</h2>
<p>I’m aware of the following R packages that process profiler data, ordered by date of first CRAN release:</p>
<ul>
<li><p><a href="https://cran.r-project.org/web/packages/proftools/index.html" class="external-link"><em>proftools</em></a>: Mature, the paper’s includes facilities for summarizing results at the function, call, and source line level; for filtering to narrow the focus to functions of primary interest; and for visualizing profiling data. Also offers an export to <a href="http://valgrind.org/docs/manual/cl-manual.html" class="external-link">callgrind</a> format.</p></li>
<li><p><a href="https://rstudio.github.io/profvis/" class="external-link"><em>profvis</em></a>: Interactive exploration of the flame graph and call tree in a web browser.</p></li>
<li><p><a href="https://github.com/artemklevtsov/prof.tree#proftree" class="external-link"><em>prof.tree</em></a>: Shows a call tree on the console. A similar project, <a href="https://github.com/brodieG/treeprof" class="external-link"><em>treeprof</em></a>, never made it to CRAN.</p></li>
</ul>
<p>I’d also like to mention two other tools outside the R ecosystem:</p>
<ul>
<li><p><a href="https://github.com/google/pprof" class="external-link"><code>pprof</code></a>: A new tool written in Go, supports varios output formats (including callgrind) and also interactive exploration of the flame graph and call graph in a web browser.</p></li>
<li><p><a href="https://kcachegrind.github.io/html/Home.html" class="external-link">KCacheGrind</a>: KDE-based interactive exploration, expects callgrind input.</p></li>
</ul>
</div>
<div id="caveats" class="section level2">
<h2 class="hasAnchor">
<a href="#caveats" class="anchor"></a>Caveats</h2>
<p>A few major points have been left unresolved until a forthcoming release:</p>
<ul>
<li>Nested calls back into R code are not fully supported yet. In situations where native code evaluates R expressions which then invoke native code again, the recorded stack trace will look wrong.</li>
</ul>
<p>If your R code calls into native code, or if you want to try <code>pprof</code> with R profiling results, give the <em>jointprof</em> package a try! If you discover problems or have comments, <a href="https://github.com/r-prof/jointprof/issues" class="external-link">file an issue</a>. I’d be especially grateful for help with other Linux distributions or OS X.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="https://krlmlr.info" class="external-link external-link">Kirill Müller</a>, <a href="https://www.r-consortium.org" class="external-link external-link">R Consortium</a>.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link external-link">pkgdown</a> 1.6.1.9001.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
